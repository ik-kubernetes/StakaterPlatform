# Use this Makefile if you want to setup/deploy/destroy StakaterPlatform from devstation(local workstation;laptop, computer etc.)

.ONESHELL:
SHELL= /bin/bash

include configs/variables.config

ARGS := $(STAKATER_PLATFORM_SSH_GIT_URL) $(STAKATER_PLATFORM_BRANCH) $(DOMAIN) $(BASE64_ENCODED_AWS_ACCESS_KEY_ID) $(BASE64_ENCODED_AWS_SECRET_ACCESS_KEY) $(BASE64_ENCODED_IMC_CONFIG) $(BASE64_ENCODED_JENKINS_CFG) $(KEYCLOAK_CLIENT_ID) $(KEYCLOAK_CLIENT_SECRET) $(BASE64_ENCODED_GITHUB_TOKEN) $(BASE64_ENCODED_GITLAB_TOKEN) $(BASE64_ENCODED_BITBUCKET_TOKEN) $(BASE64_ENCODED_NEXUS_ADMIN_ACCOUNT_JSON) $(BASE64_ENCODED_NEXUS_CLUSTER_ACCOUNT_JSON) $(NEXUS_ADMIN_ACCOUNT_USERNAME) $(NEXUS_CLUSTER_ACCOUNT_USERNAME) $(BASE64_ENCODED_ALERTMANAGER_CONFIG) $(BASE64_ENCODED_KEYCLOAK_CONFIG) $(BASE64_ENCODED_PROXYINJECTOR_CONFIG) $(BASE64_ENCODED_SLACK_CHANNEL) $(BASE64_ENCODED_SLACK_WEBHOOK_URL)

configure:
	git checkout $STAKATER_PLATFORM_BRANCH
	bash scripts/configure.sh $(ARGS)
	git add .
	git commit -a -m "[skip ci] update vars for deployment"
	git push -u origin $STAKATER_PLATFORM_BRANCH || true

deploy:
	bash scripts/install.sh
	sleep 480
	bash scripts/verify.sh

verify:
	echo "$(CLOUD_PROVIDER) $(DOMAIN)"
	bash scripts/verify.sh

destroy:
	bash scripts/destroy.sh

.PHONY: configure deploy verify destroy